<div class="tree-wrapper">
	<button mat-raised-button color="warn" *ngIf="isRefreshing && searchIn === 'content'" (click)="abortSearch()" style="display: block;">
		<mat-icon>cancel</mat-icon>
		{{ 'button.abort' | translate }}
	</button>
	<mat-form-field class="search">
		<input
			matInput
			type="text"
			[(ngModel)]="filterByString"
			(ngModelChange)="onSearchChange()"
			(keydown.enter)="onSearchChange(true)"
			(onKeyboardClose)="onSearchChange(true)"
			[disabled]="isRefreshing"
			#searchInput
			virtualKeyboard
			ktype="text"
		/>
		<mat-icon matPrefix>search</mat-icon>
	</mat-form-field>
	<mat-form-field class="search">
		<mat-label>{{ 'files.search_in' | translate }}</mat-label>
		<mat-select [(ngModel)]="searchIn" (selectionChange)="onSearchChange(true)">
			<mat-option value="names">{{ 'files.names' | translate }}</mat-option>
			<mat-option value="content">{{ 'files.content' | translate }}</mat-option>
		</mat-select>
	</mat-form-field>
	<mat-slide-toggle class="checkbox_en" color="primary" [(ngModel)]="enableSelect" (change)="onEnableSelectChange()" [disabled]="selectBusy">{{
		'checkbox_enable' | translate
	}}</mat-slide-toggle>
	<div class="center-vertical-horizontal">
		<img src="assets/pics/{{ env.platform.spinner }}" *ngIf="isRefreshing" />
	</div>
	<mat-tree [dataSource]="nestedDataSourceContent" [treeControl]="nestedTreeControlContent" *ngIf="searchIn === 'content'">
		<mat-tree-node *matTreeNodeDef="let node">
			<li class="leaf">
				<div (click)="openContentFile(node)" class="search-line">{{ node.line }}</div>
			</li>
		</mat-tree-node>
		<mat-nested-tree-node *matTreeNodeDef="let node; when: hasNestedChildContent">
			<li class="mat-typography">
				<div (click)="toggleContentNode(node)">
					<mat-icon>
						{{ nestedTreeControlContent.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
					</mat-icon>
					<mat-icon class="primary-light">insert_drive_file</mat-icon>
					<span class="search-file">{{ node.file }} </span>
					<span class="search-path">{{ node.path }} </span>
				</div>
				<ul [class.invisible]="!nestedTreeControlContent.isExpanded(node)">
					<ng-container matTreeNodeOutlet></ng-container>
				</ul>
			</li>
		</mat-nested-tree-node>
	</mat-tree>
	<mat-tree [dataSource]="nestedDataSource" [treeControl]="nestedTreeControl" *ngIf="searchIn === 'names'">
		<mat-tree-node *matTreeNodeDef="let node">
			<li (contextmenu)="openContextMenu($event, node)" class="leaf">
				<div (click)="openFile(node)" [class.selected]="lastSelectedNode === node">
					<mat-checkbox *ngIf="enableSelect"
						class="checklist-leaf-node"
						[checked]="prj.checklistSelection.isSelected(node)"
						(change)="leafSelectionToggle(node, $event)"
						(click)="$event.stopPropagation()"
					></mat-checkbox>
					<mat-icon color="primary">insert_drive_file</mat-icon>
					<span>{{ node.name }}</span>
				</div>
			</li>
		</mat-tree-node>
		<mat-nested-tree-node *matTreeNodeDef="let node; when: hasNestedChild">
			<li class="mat-typography" (contextmenu)="openContextMenu($event, node)">
				<div [class.selected]="lastSelectedNode === node" (click)="toggleNode(node)">
					<mat-icon>
						{{ nestedTreeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
					</mat-icon>
					<mat-checkbox *ngIf="enableSelect"
						[checked]="descendantsAllSelected(node)"
						[indeterminate]="!descendantsAllSelected(node) && descendantsPartiallySelected(node)"
						(change)="nodeSelectionToggle(node)"
						(click)="$event.stopPropagation()"
					></mat-checkbox>
					<mat-icon class="primary-light">
						{{ nestedTreeControl.isExpanded(node) ? 'folder_open' : 'folder' }}
					</mat-icon>
					<span>{{ node.name }} </span>
				</div>
				<ul [class.invisible]="!nestedTreeControl.isExpanded(node)">
					<ng-container matTreeNodeOutlet></ng-container>
				</ul>
			</li>
		</mat-nested-tree-node>
	</mat-tree>
</div>
<div class="menu-backdrop" *ngIf="menuVisible" (click)="closeContextMenu()" (contextmenu)="$event.preventDefault()">
	<div class="menu-wrapper">
		<div class="menu mat-elevation-z3" [style.top]="menuTop" [style.left]="menuLeft" #menuDiv>
			<div>
				<button mat-button (click)="newFile(lastSelectedNode)">
					<mat-icon>note_add</mat-icon>{{ 'projects.toolbar.new_file' | translate }}...
				</button>
				<button mat-button (click)="newFolder(lastSelectedNode)">
					<mat-icon>create_new_folder</mat-icon>{{ 'projects.toolbar.new_folder' | translate }}...
				</button>
				<button mat-button (click)="copy(lastSelectedNode)">
					<mat-icon>file_copy</mat-icon>{{ 'copy' | translate }}...
				</button>
				<button mat-button color="warn" (click)="delete(lastSelectedNode)">
					<mat-icon>delete</mat-icon>{{ 'delete' | translate }}...
				</button>
			</div>
			<mat-divider></mat-divider>
			<div>
				<button
					mat-button
					(click)="moveHere(lastSelectedNode)"
					[disabled]="prj.checklistSelection.selected.length === 0"
				>
					<mat-icon>arrow_forward</mat-icon>Move selected items
				</button>
			</div>
		</div>
	</div>
</div>
