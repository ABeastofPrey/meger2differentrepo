<div class="wrapper mat-typography">
  <div class="project-tree">
    <div
      *ngIf="currProject && service.modeToggle === 'prj'"
      tourAnchor="project-tree"
      id="trees"
    >
      <div class="title" tourAnchor="projectName">{{ currProject.name }}</div>
      <mat-tree
        [dataSource]="nestedDataSource"
        [treeControl]="nestedTreeControl"
        [class.busy]="service.busy"
      >
        <mat-tree-node
          *matTreeNodeDef="let node"
          [class.disabled]="isNodeDisabled(node)"
        >
          <li
            class="leaf"
            [class.background-leaf]="node.type === 'BG'"
            (contextmenu)="openContextMenu($event, node)"
          >
            <div
              (click)="openFile(node)"
              [class.selected]="
                lastSelectedNode === node && service.mode !== 'plugin'
              "
              [class.disabled]="isNodeDisabled(node)"
              [class.background-node]="node.type === 'BG'"
            >
              <mat-icon
                class="leaf mat-primary"
                color="primary"
                *ngIf="node.type === 'File'"
                >insert_drive_file</mat-icon
              >
              <mat-icon
                class="leaf mat-primary"
                color="primary"
                *ngIf="node.type === 'BG'"
                >insert_drive_file</mat-icon
              >
              <mat-icon
                class="leaf mat-primary"
                color="primary"
                *ngIf="node.type === 'Data'"
                >format_list_numbered</mat-icon
              >
              <mat-icon
                class="leaf library mat-primary"
                *ngIf="node.type === 'Library'"
                >insert_drive_file</mat-icon
              >
              <mat-icon
                class="leaf library mat-primary"
                *ngIf="node.type === 'Dependency'"
                >public</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Settings'"
                >settings_applications</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === projectPoints"
                >line_style</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Errors'"
                >error</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Macros'"
                >keyboard</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Frames'"
                >filter_b_and_w</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Pallets'"
                >view_quilt</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Grippers'"
                >settings_input_component</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'IO'"
                >device_hub</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Vision'"
                >linked_camera</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Conveyor'"
                >power_input</mat-icon
              >
              <mat-icon
                class="mat-primary"
                color="primary"
                *ngIf="node.type === 'Payloads'"
                >markunread_mailbox</mat-icon
              >
              <span>{{
                node.name.length > 0
                  ? node.name
                  : ('projectTree.' + node.type | translate)
              }}</span>
            </div>
          </li>
        </mat-tree-node>
        <mat-nested-tree-node *matTreeNodeDef="let node; when: hasNestedChild">
          <li
            (contextmenu)="openContextMenu($event, node)"
            [tourAnchor]="
              (node.parent && node.parent.name.length > 0
                ? node.parent.name + '-'
                : node.parent?.type
                ? node.parent.type + '-'
                : '') +
              node.type +
              (node.name && node.name.length > 0 ? '-' + node.name : '')
            "
            [id]="
              node.type +
              (node.name && node.name.length > 0 ? '-' + node.name : '')
            "
          >
            <div
              [class.selected]="lastSelectedNode === node"
              (click)="toggleNode(node); selectNode(node)"
              [matTooltip]="node.ref && node.ref.desc ? node.ref.desc : 'nope'"
              matTooltipShowDelay="0"
              [matTooltipDisabled]="!node.ref || !node.ref.desc || cmn.isTablet"
            >
              <mat-icon class="mat-primary">
                {{
                  nestedTreeControl.isExpanded(node)
                    ? 'expand_more'
                    : 'chevron_right'
                }}
              </mat-icon>
              <mat-icon *ngIf="node.type === 'Project'" class="mat-primary"
                >folder_special</mat-icon
              >
              <mat-icon *ngIf="node.type !== 'Project'" class="primary-light">
                {{
                  nestedTreeControl.isExpanded(node) ? 'folder_open' : 'folder'
                }}
              </mat-icon>
              <span [class.enabledApp]="node.ref && node.ref.active">
                <span *ngIf="node.type !== 'Auxiliary'">{{
                  node.name.length > 0
                    ? node.name
                    : ('projectTree.' + node.type | translate)
                }}</span>
                <span *ngIf="node.type === 'Auxiliary'">{{
                  node.name.length > 0
                    ? node.name
                    : ('projects.toolbar.Auxiliary' | translate)
                }}</span>
              </span>
              <span
                class="status"
                *ngIf="node.ref && node.ref.status !== -1"
                [class.status-running]="node.ref && node.ref.status === 1"
              >
                ({{ 'projects.status.' + node.ref.status | translate }})
              </span>
              <span class="status" *ngIf="node.type === 'Dependencies'">
                ({{
                  (!currProject.dependenciesLoaded
                    ? 'projects.status.-1'
                    : 'projects.loaded') | translate
                }})
              </span>
              <span
                class="status"
                *ngIf="node.type === 'Apps' && prj.activeProject"
              >
                ({{ 'projects.loaded' | translate }})
              </span>
            </div>
            <ul
              [class.invisible]="!nestedTreeControl.isExpanded(node)"
              [id]="
                node.type +
                (node.name && node.name.length > 0 ? '-' + node.name : '') +
                '-ul'
              "
            >
              <ng-container matTreeNodeOutlet></ng-container>
            </ul>
          </li>
        </mat-nested-tree-node>
      </mat-tree>
    </div>
    <div
      id="plugin"
      [class.pluginHidden]="!(currProject && service.modeToggle === 'prj')"
    ></div>
  </div>
  <div *ngIf="service.modeToggle === 'mc'" class="file-tree-wrapper">
    <div class="title">{{ 'files.tree' | translate }}</div>
    <mc-file-tree></mc-file-tree>
  </div>
</div>
<div
  class="menu-backdrop"
  *ngIf="menuVisible"
  (click)="closeContextMenu()"
  (contextmenu)="$event.preventDefault()"
>
  <div class="menu-wrapper">
    <div
      class="menu mat-elevation-z3"
      [style.top]="menuTop"
      [style.left]="menuLeft"
    >
      <div
        *ngIf="
          lastSelectedNode &&
          lastSelectedNode.type === 'Apps' &&
          !login.isOperator
        "
      >
        <button mat-button (click)="newApp()">
          <mat-icon color="primary">add</mat-icon
          >{{ 'projects.toolbar.new_app' | translate }}...
        </button>
      </div>
      <!-- new background task -->
      <div
        *ngIf="
          lastSelectedNode &&
          lastSelectedNode.type === 'Auxiliary' &&
          !login.isOperator
        "
      >
        <button
          mat-button
          [disabled]="bgtCount >= 8"
          (click)="newBackgroundTask()"
        >
          <mat-icon class="primary-light">add</mat-icon>
          {{ 'projects.toolbar.newBackgroundTask' | translate }}...
        </button>
      </div>
      <!-- end -->
      <div *ngIf="lastSelectedNode && lastSelectedNode.type === 'Dependencies'">
        <button
          mat-button
          (click)="toggleDependencies()"
          [disabled]="prj.activeProject"
        >
          <mat-icon color="primary">
            {{
              prj.currProject.value.dependenciesLoaded ? 'stop' : 'play_arrow'
            }}
          </mat-icon>
          {{
            (prj.currProject.value.dependenciesLoaded
              ? 'projects.toolbar.dep_unload'
              : 'projects.toolbar.dep_load') | translate
          }}
        </button>
        <mat-divider
          *ngIf="!currProject.dependenciesLoaded && !login.isOperator"
        ></mat-divider>
        <button
          mat-button
          (click)="newDep()"
          *ngIf="!currProject.dependenciesLoaded && !login.isOperator"
        >
          <mat-icon color="primary">add</mat-icon
          >{{ 'projects.toolbar.new_dep' | translate }}...
        </button>
      </div>
      <div *ngIf="lastSelectedNode && lastSelectedNode.type === 'App'">
        <button
          mat-button
          (click)="runApp(lastSelectedNode.name)"
          *ngIf="lastSelectedNode.ref && lastSelectedNode.ref.status === 7"
        >
          <mat-icon color="primary">play_arrow</mat-icon
          >{{ 'projects.toolbar.run' | translate }}
          {{ lastSelectedNode.name }}
        </button>
        <button
          mat-button
          (click)="newLib(lastSelectedNode.name)"
          *ngIf="!prj.activeProject && !login.isOperator"
        >
          <mat-icon color="primary">add</mat-icon
          >{{ 'projects.toolbar.new_lib' | translate }}...
        </button>
        <mat-divider
          *ngIf="!prj.activeProject && !login.isOperator"
        ></mat-divider>
        <button
          mat-button
          (click)="renameApp(lastSelectedNode.name)"
          *ngIf="!prj.activeProject && !login.isOperator"
        >
          <mat-icon color="primary">edit</mat-icon
          >{{ 'projects.toolbar.rename' | translate }}
          {{ lastSelectedNode.name }}...
        </button>
        <button
          mat-button
          (click)="saveAppAs(lastSelectedNode.name)"
          *ngIf="!prj.activeProject && !login.isOperator"
        >
          <mat-icon color="primary">save</mat-icon
          >{{ 'projects.toolbar.save_as' | translate }}...
        </button>
        <mat-divider *ngIf="!prj.activeProject"></mat-divider>
        <button
          mat-button
          color="warn"
          (click)="deleteApp(lastSelectedNode.name)"
          *ngIf="!prj.activeProject && !login.isOperator"
        >
          <mat-icon color="warn">delete</mat-icon>{{ 'delete' | translate }}
          {{ lastSelectedNode.name }}
        </button>
      </div>
      <div
        *ngIf="
          lastSelectedNode &&
          lastSelectedNode.type === 'Libraries' &&
          !login.isOperator
        "
      >
        <button mat-button (click)="newLib()">
          <mat-icon color="primary">add</mat-icon
          >{{ 'projects.toolbar.new_lib' | translate }}...
        </button>
      </div>
      <div
        *ngIf="
          lastSelectedNode &&
          lastSelectedNode.type === 'Library' &&
          !login.isOperator
        "
      >
        <button mat-button color="warn" (click)="deleteLib()">
          <mat-icon color="warn">delete</mat-icon>{{ 'delete' | translate }}
          {{ lastSelectedNode.name }}
        </button>
      </div>
      <!-- curd background task -->
      <div *ngIf="lastSelectedNode && lastSelectedNode.type === 'BG'">
        <button mat-button (click)="runApp(lastSelectedNode.name, true)">
          <mat-icon>play_arrow</mat-icon
          >{{ 'projects.toolbar.run' | translate }}
          {{ lastSelectedNode.name }}
        </button>
        <mat-divider *ngIf="!login.isOperator"></mat-divider>
        <button
          mat-button
          (click)="renameApp(lastSelectedNode.name, true)"
          *ngIf="!login.isOperator"
        >
          <mat-icon class="primary-light">edit</mat-icon
          >{{ 'projects.toolbar.rename' | translate }}
          {{ lastSelectedNode.name }}...
        </button>
        <button
          mat-button
          (click)="saveAppAs(lastSelectedNode.name, true)"
          *ngIf="!login.isOperator"
        >
          <mat-icon class="primary-light">save</mat-icon
          >{{ 'projects.toolbar.save_as' | translate }}...
        </button>
        <mat-divider *ngIf="!login.isOperator"></mat-divider>
        <button
          mat-button
          color="warn"
          (click)="deleteApp(lastSelectedNode.name, true)"
          *ngIf="!login.isOperator"
        >
          <mat-icon class="primary-light">delete</mat-icon
          >{{ 'delete' | translate }}
          {{ lastSelectedNode.name }}
        </button>
      </div>
      <div
        *ngIf="
          lastSelectedNode &&
          lastSelectedNode.type === 'Dependency' &&
          !login.isOperator
        "
      >
        <button mat-button (click)="renameDep(lastSelectedNode.name)">
          <mat-icon color="primary">edit</mat-icon
          >{{ 'projects.toolbar.rename' | translate }}
          {{ lastSelectedNode.name }}...
        </button>
        <button mat-button (click)="saveDepAs(lastSelectedNode.name)">
          <mat-icon color="primary">save</mat-icon
          >{{ 'projects.toolbar.save_as' | translate }}...
        </button>
        <mat-divider></mat-divider>
        <button mat-button color="warn" (click)="deleteDep()">
          <mat-icon color="warn">delete</mat-icon>{{ 'delete' | translate }}
          {{ lastSelectedNode.name }}
        </button>
      </div>
    </div>
  </div>
</div>
